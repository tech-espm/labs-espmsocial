
<div class="row">
	<div class="col-lg-12">
		<div class="panel panel-default">
			<div class="panel-body dataTable_wrapper">
				<table class="table table-striped table-hover" id="tabela"></table>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" tabindex="-1" role="dialog" id="modalExcluir">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Fechar"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title">Oops...</h4>
			</div>
			<div class="modal-body">
				<p>
					Tem certeza que deseja excluir o usuário <span id="lblNome"></span>? Esta operação <b class="col-h">NÃO</b> pode ser desfeita!
				</p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-danger" onclick="excluir()"><i class="fa fa-check"></i>Excluir</button>
				<button type="button" class="btn btn-outline btn-default" data-dismiss="modal"><i class="fa fa-times"></i>Cancelar</button>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" tabindex="-1" role="dialog" id="modalRedefinirSenha">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Fechar"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title">Oops...</h4>
			</div>
			<div class="modal-body">
				<p>
					Tem certeza que deseja redefinir a senha do usuário <span id="lblNomeRedefinirSenha"></span> para "1234"? Esta operação <b class="col-h">NÃO</b> pode ser desfeita!
				</p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary" onclick="redefinirSenha()"><i class="fa fa-check"></i>Redefinir Senha</button>
				<button type="button" class="btn btn-outline btn-default" data-dismiss="modal"><i class="fa fa-times"></i>Cancelar</button>
			</div>
		</div>
	</div>
</div>

<%- contentFor("scripts") %>
<script type="text/javascript">
	//<![CDATA[
	"use strict";

	var tabela = prepareDataTable("tabela", {
		order: [[2, "asc"]],
		deferRender: true,
		columns: [
			{ title: "", "class": "col-min", searchable: false, orderable: false, data: "id", render: function (v, type, row) { return "<a target=\"_blank\" title=\"Editar\" href=\"<%- root %>/usuario/alterar?id=" + row.id + "\" class=\"btn btn-outline btn-primary\"><i class=\"fa fa-nomargin fa-edit\"></i></a> <button title=\"Redefinir Senha\" type=\"button\" class=\"btn btn-outline btn-primary\"><i class=\"fa fa-nomargin fa-lock\"></i></button> <button title=\"Excluir\" type=\"button\" data-excluir=\"1\" class=\"btn btn-outline btn-danger\"><i class=\"fa fa-nomargin fa-times\"></i></button>"; } },
			{ title: " ", "class": "col-25", render: function (v, type, row) { return (v ? ('<img class="profile-img" style="margin: 0;" width="40" height="40" src="<%- root %>/imagens/perfil/' + row.id + '.jpg?' + v + '" alt="Imagem de perfil" />') : '<img class="profile-img" style="margin: 0;" width="40" height="40" src="<%- root %>/imagens/user.png" alt="Imagem de perfil" />'); }, searchable: false, orderable: false, data: "versao" },
			{ title: "Login", "class": "col-25", render: encode, data: "login" },
			{ title: "Nome", "class": "col-25", render: encode, data: "nome" },
			{ title: "Cargo", "class": "col-25", render: encode, data: "cargo" },
			{ title: "Equipe", "class": "col-25", render: encode, data: "equipe" },
			{ title: "Criação", "class": "col-25", "type": "customdateint", data: "criacao" },
			{ title: "Email", "class": "col-15", render: encode, data: "email" },
            { title: "Telefone","class": "col-10", render: encode, data: "telefone" },
			{ title: "WhatsApp","class": "col-10", render: encode, data: "whatsapp" },
			{ title: "Rede Social", "class": "col-25", render: encode, data: "rede_social" },
			{ title: "Curso","class": "col-10", render: encode, data: "curso" },
			{ title: "Período Entrada","class": "col-10", render: encode, data: "periodo_entrada" },
			{ title: "Período Saída","class": "col-10", render: encode, data: "periodo_saida" },
			{ title: "Semestre Entrada","class": "col-10", data: "semestre_entrada" },
			{ title: "Semestre Saída","class": "col-10", data: "semestre_saida" },
			{ title: "Semestre Atual","class": "col-10", data: "semestre_atual" },
			{ title: "Ativo", "class": "col-min", render: function (v, type, row) { return (v ? '<span class="col-h2">Sim</span>' : "Não");  }, data: "ativo" }
		],
		data: <%- lista %>,
		export: { title: "Usuários" }
	});

	var trClicada;

	$("#tabela").on("click", "tbody button", function () {
		if (JsonWebApi.active)
			return;

		var usuario = tabela.row(trClicada = this.parentNode.parentNode).data();

		if (this.getAttribute("data-excluir")) {
			$("#lblNome").text(usuario.login);

			$("#modalExcluir").modal({
				backdrop: "static",
				keyboard: true
			});
		} else {
			$("#lblNomeRedefinirSenha").text(usuario.login);

			$("#modalRedefinirSenha").modal({
				backdrop: "static",
				keyboard: true
			});
		}
	});

	function excluir() {
		if (JsonWebApi.active || !trClicada)
			return;

		$("#modalExcluir").modal("hide");

		var usuario = tabela.row(trClicada).data();

		Notification.wait();

		JsonWebApi.get("<%- root %>/api/usuario/excluir", function (response) {
			if (response.success) {
				Notification.success("Usuário excluído com sucesso! " + emoji.happy);
				tabela.row(trClicada).remove().draw();
			} else {
				Notification.error(response.value, true);
			}
			trClicada = null;
		}, "id", usuario.id);
	}

	function redefinirSenha() {
		if (JsonWebApi.active || !trClicada)
			return;

		$("#modalRedefinirSenha").modal("hide");

		var usuario = tabela.row(trClicada).data();

		Notification.wait();

		JsonWebApi.get("<%- root %>/api/usuario/redefinirSenha", function (response) {
			if (response.success)
				Notification.success("Senha redefinida com sucesso! " + emoji.happy);
			else
				Notification.error(response.value, true);
			trClicada = null;
		}, "id", usuario.id);
	}

	//]]>
</script>
